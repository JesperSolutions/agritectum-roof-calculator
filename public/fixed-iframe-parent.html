<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fixed Iframe Parent - No Feedback Loop</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        /* CRITICAL: No height constraints on iframe container */
        .iframe-container {
            width: 100%;
            max-width: 100%;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            overflow: visible; /* Allow content to show */
            transition: all 0.3s ease;
            position: relative;
        }
        
        .iframe-container iframe {
            width: 100%;
            border: none;
            display: block;
            min-height: 600px; /* Reasonable starting height */
            /* Height will be set by JavaScript */
        }
        
        .status-bar {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè† Roof Impact Calculator (Fixed)</h1>
        
        <div class="status-bar">
            <div><strong>Status:</strong> <span id="status">Initializing...</span></div>
            <div><strong>Current Height:</strong> <span id="current-height">Not set</span></div>
            <div><strong>Messages:</strong> <span id="message-count">0</span></div>
            <div><strong>Last Update:</strong> <span id="last-update">Never</span></div>
            <div><strong>Height Requests Sent:</strong> <span id="request-count">0</span></div>
        </div>
        
        <div class="controls">
            <button onclick="manualHeightRequest()">üìè Manual Height Request</button>
            <button onclick="refreshIframe()">üîÑ Refresh Calculator</button>
            <button onclick="resetCounters()">üîÑ Reset Counters</button>
        </div>
        
        <div class="iframe-container" id="iframe-container">
            <iframe 
                id="roof-calculator"
                src="https://zingy-cassata-05c5bf.netlify.app"
                title="Roof Impact Calculator"
                allowfullscreen>
            </iframe>
        </div>
    </div>

    <script>
        let messageCount = 0;
        let requestCount = 0;
        let currentHeight = 0;
        let lastHeightReceived = 0;
        let isInitialized = false;
        
        const iframe = document.getElementById('roof-calculator');
        const container = document.getElementById('iframe-container');
        const statusEl = document.getElementById('status');
        const heightEl = document.getElementById('current-height');
        const countEl = document.getElementById('message-count');
        const updateEl = document.getElementById('last-update');
        const requestCountEl = document.getElementById('request-count');
        
        function updateStatus(message, type = 'success') {
            statusEl.textContent = message;
            statusEl.className = type;
            console.log(`[Status] ${message}`);
        }
        
        function updateCounters() {
            countEl.textContent = messageCount;
            requestCountEl.textContent = requestCount;
        }
        
        function setIframeHeight(height) {
            if (height && height > 0 && height !== currentHeight) {
                const previousHeight = currentHeight;
                currentHeight = height;
                
                // Set the iframe height
                iframe.style.height = height + 'px';
                
                // Update UI
                heightEl.textContent = height + 'px';
                updateEl.textContent = new Date().toLocaleTimeString();
                
                // Visual feedback
                container.style.borderColor = '#28a745';
                setTimeout(() => {
                    container.style.borderColor = '#e1e5e9';
                }, 1000);
                
                console.log(`üìè Height updated: ${previousHeight}px ‚Üí ${height}px`);
                updateStatus(`Height updated to ${height}px`);
                
                return true; // Height was actually changed
            }
            return false; // No change
        }
        
        function sendHeightRequest() {
            if (iframe.contentWindow) {
                requestCount++;
                updateCounters();
                
                iframe.contentWindow.postMessage({ 
                    type: 'request-height-update',
                    timestamp: Date.now()
                }, '*');
                
                console.log(`üîÑ Height request sent (#${requestCount})`);
                return true;
            } else {
                console.error('‚ùå Cannot access iframe content window');
                updateStatus('Cannot communicate with iframe', 'error');
                return false;
            }
        }
        
        // FIXED: Enhanced message listener that doesn't create feedback loops
        window.addEventListener('message', function(event) {
            // Security check (optional)
            if (event.origin !== 'https://zingy-cassata-05c5bf.netlify.app') {
                console.warn('‚ö†Ô∏è Message from unexpected origin:', event.origin);
                return;
            }
            
            messageCount++;
            updateCounters();
            
            console.log('üì® Message received:', event.data, 'from:', event.origin);
            
            if (event.data && typeof event.data === 'object') {
                if (event.data.iframeHeight) {
                    const newHeight = event.data.iframeHeight;
                    lastHeightReceived = newHeight;
                    
                    // CRITICAL: Only set height, don't request another update!
                    const heightChanged = setIframeHeight(newHeight);
                    
                    if (heightChanged) {
                        console.log(`‚úÖ Height successfully updated to ${newHeight}px`);
                    } else {
                        console.log(`‚ÑπÔ∏è Height unchanged (${newHeight}px)`);
                    }
                    
                    // Mark as initialized after first height received
                    if (!isInitialized) {
                        isInitialized = true;
                        updateStatus('Calculator fully loaded and height synchronized');
                    }
                    
                    // DO NOT REQUEST HEIGHT AGAIN HERE!
                    // This was causing the feedback loop
                    
                } else if (event.data.type) {
                    console.log(`üì® Other message type: ${event.data.type}`);
                }
            }
        });
        
        // Handle iframe load
        iframe.addEventListener('load', function() {
            console.log('üìã Iframe loaded successfully');
            updateStatus('Calculator loaded, requesting initial height...');
            
            // Request height only once after load, with delays
            setTimeout(() => {
                if (sendHeightRequest()) {
                    updateStatus('Initial height request sent...');
                }
            }, 1000);
            
            // Backup request if no response
            setTimeout(() => {
                if (!isInitialized) {
                    console.log('‚ö†Ô∏è No height received yet, sending backup request');
                    sendHeightRequest();
                }
            }, 3000);
        });
        
        iframe.addEventListener('error', function() {
            console.error('‚ùå Iframe failed to load');
            updateStatus('Failed to load calculator', 'error');
        });
        
        // Manual functions for testing
        function manualHeightRequest() {
            console.log('üîß Manual height request triggered');
            if (sendHeightRequest()) {
                updateStatus('Manual height request sent...');
            }
        }
        
        function refreshIframe() {
            console.log('üîÑ Refreshing iframe');
            updateStatus('Refreshing calculator...');
            
            // Reset state
            isInitialized = false;
            currentHeight = 0;
            heightEl.textContent = 'Not set';
            
            // Refresh iframe
            iframe.src = iframe.src;
        }
        
        function resetCounters() {
            messageCount = 0;
            requestCount = 0;
            updateCounters();
            console.log('üîÑ Counters reset');
        }
        
        // Initialize
        updateStatus('Initializing iframe communication...');
        console.log('üöÄ Parent page initialized');
        
        // REMOVED: Periodic height requests that were causing spam
        // Only request height manually or on specific events
        
        // Handle page visibility changes (but don't spam requests)
        let visibilityRequestSent = false;
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && isInitialized && !visibilityRequestSent) {
                console.log('üì± Page became visible, requesting height update');
                sendHeightRequest();
                visibilityRequestSent = true;
                
                // Reset flag after delay
                setTimeout(() => {
                    visibilityRequestSent = false;
                }, 5000);
            }
        });
        
        // Debug functions (available in console)
        window.debugIframe = {
            requestHeight: manualHeightRequest,
            getCurrentHeight: () => currentHeight,
            getMessageCount: () => messageCount,
            getRequestCount: () => requestCount,
            isInitialized: () => isInitialized,
            getLastHeight: () => lastHeightReceived
        };
        
        console.log('üêõ Debug functions available: window.debugIframe');
    </script>
</body>
</html>